Resumen del proyecto Tablero SIAN
=================================

Este documento reemplaza al antiguo script ``resumen.py`` y ofrece una vista
rápida de los componentes principales del repositorio.

Aplicación web
--------------
* ``app.py``: servicio FastAPI que expone un formulario HTML para ejecutar los
  procesos de sincronización. Gestiona las conexiones a PostgreSQL, consulta
  parámetros almacenados y orquesta los ciclos de procesamiento Penal y de
  Violencia.
* ``templates/index.html``: plantilla Jinja2 utilizada para renderizar el
  formulario web presentado por la aplicación.

Procesos de sincronización
--------------------------
* ``retornoxmlmp.py``: script de línea de comandos que consulta envíos
  pendientes, consume el servicio SOAP del Ministerio Público y guarda las
  respuestas XML completas en la tabla ``retornomp``.
* ``historialsian.py``: utilidades para normalizar y almacenar el historial de
  estados de las notificaciones, incluyendo operaciones de depuración sobre
  ``enviocedulanotificacionpolicia``.

### Detalle del flujo de sincronización
* ``retornoxmlmp.py`` filtra los registros de ``enviocedulanotificacion`` cuyo
  ``laststagesian`` está en ``NULL``, ``Pendiente`` o ``Ingresada`` y cuya
  ``fechalaststate`` tiene una antigüedad máxima de diez días. Por cada envío
  válido invoca la operación SOAP ``ObtenerEstadoNotificacion`` del Ministerio
  Público y almacena el XML de respuesta en ``retornomp``.
* La función ``_almacenar_xml`` inserta los nuevos XML con ``procesado = FALSE``
  y ``fechaproceso = NULL``. Si el XML cambia respecto del almacenado, actualiza
  la fila existente y vuelve a marcarla como pendiente de procesamiento.
* ``historialsian.py`` usa ``pre_historial()`` para leer exclusivamente las
  filas de ``retornomp`` con ``procesado = FALSE``. Tras generar el historial,
  ``_marcar_retornomp_procesado`` establece ``procesado = TRUE`` y registra la
  fecha, asegurando que solo se reprocesen los registros con novedades.

Archivos SQL de apoyo
---------------------
* ``set_laststate.sql`` y ``ultimoestado.sql``: scripts SQL para actualizar y
  consultar estados en la base de datos.
* ``analisisfinnotif.sql``: consulta orientada al análisis de notificaciones
  finalizadas.

Otros recursos
--------------
* ``requirements.txt``: dependencias Python necesarias para ejecutar los
  servicios y scripts.
* ``README.md``: instrucciones generales para instalar y ejecutar el proyecto.

Para una descripción detallada consulte cada archivo individual.
